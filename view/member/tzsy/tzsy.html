
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Jado绿能侠</title>
        <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="stylesheet" type="text/css" href="../../../css/mui.min.css" />
        <link rel="stylesheet" type="text/css" href="../../../css/mui.picker.css" />
        <link rel="stylesheet" type="text/css" href="../../..//css/mui.poppicker.css" />
        <link rel="stylesheet" type="text/css" href="../../../css/mui.yh.css" />
        
        <style type="text/css">
        .mui-input-row input[type='text'],.mui-input-row input[type='number']{float: left; width: 40% !important;}
        .mui-input-row input[readonly]{background-color: #f8f8f8;}
        .mui-input-row label{float: left; width: 60% !important;}
        .mui-btn-block{padding:8px 0px;margin-bottom: 0px;border-radius: 0px;}
        .mui-input-group{padding-top: 4px;padding-bottom: 8px;}
        .cell-view-3{float: left;width: 25%;}
        .cell-view-4{float: left;width: 33.33%;}
        .cell-view-6{float: left;width: 50%;}
        .cell-view-12{float:left;width: 100%;}
        .content-view{padding-left: 18px;}
        .mui-radius{border-radius: 100px ;padding: 3px 10px;}
        .box-check-group{float: left;width: 20%; font-size: 14px;line-height: 40px;}

        input[type="radio"]:checked:before {
            font-family: Muiicons;
            content: '\e472';
            font-size: 26px;
            font-weight: bold;
            position: absolute;
            top: -5px;
            left: -4px;
            width: 20px  !important;
            height: 20px !important;
            text-align: center;
            color: #fff !important;
        }

        input[type="radio"]:checked {
            background-color: #F59652 !important;
            border-color: #F59652 !important;
            color: #fff !important;
        }
        input[type="radio"] {
            -webkit-appearance: none !important;
            appearance: none !important;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 50%;
            /*padding: 6px;*/
            width: 20px  !important;
            height: 20px !important;
            display: inline-block;
            vertical-align: middle;
            position: relative;
            cursor: pointer;
            font-family: 'iconfonts';
            color: #fff !important;
            margin-right: 5px;
            margin-top: -2px;
        }
        .mui-btn-block{width: 92%;margin-left: 4%;}
        h5{padding: 6px 15px;}
        .mui-badge-success{background-color: #2BB673;}
        .mui-card{margin: 8px 4px;padding: 0px 2px 5px 2px;}
        .mui-input-row input{margin-top: 0px;}
        </style>
        
    </head>
    <body>
        <header class="mui-bar mui-bar-nav">
            <a class="mui-action-home mui-icon mui-icon-arrowthinleft"></a>
            <h1 class="mui-title"><!-- 运营期发电预期收益表 --></h1>
        </header>
        <div class="mui-content">
            <div class="mui-header-eqinfo">
                <div class="head-header">运营期发电预期收益表</div>
                <div class="head-english">Income statement</div>
            </div>
        </div>
        <div class="mui-after-content">
            <div class="mui-input-group">
                <div class="mui-input-row">
                    <label>投资模式</label>
                    <div class="box-check-group"><input type="radio" class='moshi' name="moshi" value="full_payment">全款</div>
                    <div class="box-check-group"><input type="radio" class='moshi' name="moshi" value="loan">贷款</div>
                    <input type="hidden" name="touzi_type" id="touzi_type" value="">
                    <input type="hidden" name="price" id="price" value="">
                </div>
                <!-- <button id='touzi_type_btn' name="touzi_type_btn" class="mui-btn mui-btn-success mui-btn-block" type='button'>- 请选择投资模式 -</button>
                <input type="hidden" name="touzi_type" id="touzi_type" value=""> -->
                <div class="mui-input-row">
                    <label>朝南面积</label>
                    <input type="number" name='ban_num' id='ban_num' class="mui-input-clear" placeholder="朝南面积">
                </div>
                <div class="mui-input-row">
                    <label>装机容量Kw</label>
                    <input type="number" name='rongliangText' id='rongliangText' placeholder="Kw" readonly>
                    <input type="hidden" name='rongliang' id='rongliang'>
                </div>
                <div class="mui-input-row">
                    <label>设备投资(元)</label>
                    <input type="text" name='touziShebei' id='touziShebei' class="mui-input-clear" placeholder="设备投资" readonly>
                </div>
                <div class="mui-input-row">
                    <label>预估年发电量</label>
                    <input type="text" name='yearDian' id='yearDian' class="mui-input-clear" placeholder="年发电量KWH" readonly>
                </div>
                <h5>贷款信息</h5>
                <button id="loan_year_btn" name="loan_year_btn" class="mui-btn mui-btn-success mui-btn-block" type='button'>贷款年限&nbsp;&nbsp;&nbsp;&nbsp;<i class="mui-icon mui-icon-arrowdown"></i></button>
                <input type="hidden" name="loan_year" id="loan_year" value="">
                <div class="mui-input-row">
                    <label>贷款年利率%</label>
                    <input type="text" name='year_rate' id='year_rate' class="mui-input-clear" placeholder="贷款年利率" readonly>
                </div>
                <h5>补贴情况</h5>
                <div class="mui-input-row">
                    <label>国家补贴:<span id="gjbt"></span>元/度,年限</label>
                    <input type="text" name='state_subsidies_time' id='state_subsidies_time' placeholder="补贴年限" value="20" readonly>
                </div>
                <div class="mui-input-row">
                    <label>其他补贴:</label>
                    <input type="text" name='fund_subsidy_time' id='fund_subsidy_time' placeholder="补贴年限" value="0" readonly>
                </div>
                <h5>投资概况</h5>
                <div class="mui-input-row">
                    <label>投资收益率%</label>
                    <input type="text" name='touzi_rate' id='touzi_rate' class="mui-input-clear" placeholder="" readonly>
                </div>
                <div class="mui-input-row">
                    <label>回本年限</label>
                    <input type="text" name='huibenyear' id='huibenyear' class="mui-input-clear" placeholder="" readonly>
                </div>
                <h5>收益分析</h5>
                <div class="mui-input-row">
                    <label style="width:100% !important;">自用比例：<span id="zybl"></span>%，￥<span id="zyjg"></span></label>
                </div>
                <div class="mui-input-row">
                    <label style="width:100% !important;">上网比例：<span id="swbl"></span>%，￥<span id="swjg"></span></label>
                </div>
                <div class="mui-input-row">
                    <label>运营期/年</label>
                    <input type="number" name='touzi_year' id='touzi_year' placeholder="年" value="25" readonly>
                </div>
                <button id="ok-view" name="ok-view" class="mui-btn mui-btn-success mui-btn-block" type='button'>查看收益明细&nbsp;&nbsp;&nbsp;&nbsp;<i class="mui-icon mui-icon-arrowdown"></i></button>
            </div>
            <!-- 收益明细 -->
            <div class="mui-card-container">
                <h5>暂无明细数据 请点击查看收益</h5>
            </div>

    </body>
<script id="mui_card_first" type="text/template">

    <div class="mui-card">
        <div class="mui-card-content">
            <div class="mui-card-content-inner">
                <div class="cell-view-6">运营期</div>
                <div class="cell-view-6 content-view"><span class="mui-radius mui-badge-success">{num}</span></div>
                <div class="cell-view-6">发电量(KWH)</div>
                <div class="cell-view-6 content-view">{dian_kwh}</div>
                <div class="cell-view-6">自用和余电上网(元)</div>
                <div class="cell-view-6 content-view">{user_self}</div>
                <div class="cell-view-6">发电补贴(元)</div>
                <div class="cell-view-6 content-view">{subsidies}</div>
                <div class="cell-view-6">预计总收益(元)</div>
                <div class="cell-view-6 content-view">{shouyiAll}</div>
                <div class="cell-view-6">等额本息(元)</div>
                <div class="cell-view-6 content-view">{interest}</div>
                <div class="cell-view-6">总投资(元)</div>
                <div class="cell-view-6 content-view">{touziAll}</div>
                <div class="cell-view-6">预计每年净收益(元)</div>
                <div class="cell-view-6 content-view">{shouyiJing}</div>

            </div>
        </div>
    </div>
</script>
<script id="mui_card_after" type="text/template">
    <div class="mui-card">
            <div class="mui-card-content">
                <div class="mui-card-content-inner">
                    <div class="cell-view-12">
                        <span class="mui-radius mui-badge-success">{num}</span>
                    </div>
                    <div class="cell-view-4">{dian_kwh}(KWH)</div>
                    <div class="cell-view-4">自用.{user_self}</div>
                    <div class="cell-view-4">补贴.{subsidies}</div>
                    <div class="cell-view-4">收益.{shouyiAll}</div>
                    <div class="cell-view-4">本息.{interest}</div>
                    <div class="cell-view-4">净收.{shouyiJing}</div>
                </div>
            </div>
        </div>
    </div>

</script>
<script src="../../../js/mui.min.js"></script>
<script src="../../../js/zepto.js"></script>
<script src="../../../js/mui.picker.js"></script>
<script src="../../../js/mui.picker.min.js"></script>
<script src="../../../js/mui.poppicker.js"></script>
<script src="../../../js/mui.enterfocus.js"></script>
<script src="../../../js/template.min.js"></script>
<script src="../../../config.js"></script>
<script src="../../../js/app.js"></script>
<script src="../../../js/sign.js"></script>
<script src="../../../js/md5.js"></script>
<script src="../../../js/jquery.1.9.1.js"></script>
<script type="text/javascript">
    var jQuery = jQuery.noConflict();
</script>
<script>
	var _json = {"each_plate_w":{"text":"\u6bcf\u5757\u591a\u5c11W","value":"270"},"tz_price_all":{"text":"\u5355\u4ef7","value":"a:1:{i:0;a:3:{s:18:\"full_payment_price\";s:2:\"6.\";s:10:\"loan_price\";s:3:\"6.5\";s:6:\"roleId\";N;}}"},"full_payment_price":{"text":"\u5168\u6b3e\u5355\u4ef7","value":"6"},"loan_price":{"text":"\u8d37\u6b3e\u5355\u4ef7","value":"6.5"},"year_time":{"text":"\u5e74\u53d1\u7535\u65f6\u95f4","value":"1150"},"state_subsidies":{"text":"\u56fd\u5bb6\u8865\u8d34","value":"0.37"},"state_subsidies_rate":{"text":"\u56fd\u5bb6\u8865\u8d34\u6bd4\u4f8b","value":"100"},"fund_subsidy_rate":{"text":"\u5176\u4ed6\u8865\u8d34\u6bd4\u4f8b","value":"100"},"fund_subsidy":{"text":"\u5176\u4ed6\u8865\u8d34","value":""},"use_rate":{"text":"\u81ea\u7528\u6bd4\u4f8b","value":"20"},"use_rate_price":{"text":"\u81ea\u7528\u6bd4\u4f8b\u4ef7\u683c","value":"0.55"},"connect_rate":{"text":"\u4e0a\u7f51\u6bd4\u4f8b","value":"80"},"connect_rate_price":{"text":"\u4e0a\u7f51\u4ef7\u683c","value":"0.391"},"interest_rate_1":{"text":"1\u5e74\u8d37\u6b3e\u5229\u7387","value":"5.655"},"interest_rate_2":{"text":"2\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.175"},"interest_rate_3":{"text":"3\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.175"},"interest_rate_4":{"text":"4\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.175"},"interest_rate_5":{"text":"5\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.175"},"interest_rate_6":{"text":"6\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.37"},"interest_rate_7":{"text":"7\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.37"},"interest_rate_8":{"text":"8\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.37"},"interest_rate_9":{"text":"9\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.37"},"interest_rate_10":{"text":"10\u5e74\u8d37\u6b3e\u5229\u7387","value":"6.37"},"acreage_coefficient":{"text":"\u9762\u79ef\u7cfb\u6570","value":"0.1636363636363636363636"}};
	var sid = localStorage.getItem("sid");
    mui.init();
    mui.plusReady(function() {
    	loadData();
    	
    	function loadData(){
    		var waiting = plus.nativeUI.showWaiting();
    		var obj_pertzinfo = {};
	    	obj_pertzinfo["sid"] = sid;
	    	var sign = GetSign(obj_pertzinfo);
	    	var param = {
		        queryData: {
		          'method': config.apimethod.pertzinfo,
		          'sign':sign,
		          'sid':sid
		        },
		        method: 'POST'
		    }
	    	$.dataRequest(param, function(rs) {
		        console.log(JSON.stringify(rs));
		        waiting.close(); 
		        if(rs.rsp=="succ")
		        {
		        	var obj = {};
		        	obj["full_payment_price"] = {"text":"全款单价","value":rs.data.full_payment_price};
		        	obj["loan_price"] = {"text":"贷款单价","value":rs.data.loan_price};
		        	obj["year_time"] = {"text":"年发电时间","value":rs.data.year_time};
		        	obj["state_subsidies"] = {"text":"国家补贴","value":rs.data.state_subsidies};
		        	obj["state_subsidies_rate"] = {"text":"国家补贴比例","value":rs.data.state_subsidies_rate};
		        	obj["fund_subsidy_rate"] = {"text":"其他补贴比例","value":rs.data.fund_subsidy_rate};
		        	obj["fund_subsidy"] = {"text":"其他补贴","value":rs.data.fund_subsidy};
		        	obj["use_rate"] = {"text":"自用比例","value":rs.data.use_rate};
		        	obj["use_rate_price"] = {"text":"自用比例价格","value":rs.data.use_rate_price};
		        	obj["connect_rate"] = {"text":"上网比例","value":rs.data.connect_rate};
		        	obj["connect_rate_price"] = {"text":"上网价格","value":rs.data.connect_rate_price};
		        	obj["interest_rate_1"] = {"text":"1年贷款利率","value":rs.data.interest_rate_1};
		        	obj["interest_rate_2"] = {"text":"2年贷款利率","value":rs.data.interest_rate_2};
		        	obj["interest_rate_3"] = {"text":"3年贷款利率","value":rs.data.interest_rate_3};
		        	obj["interest_rate_4"] = {"text":"4年贷款利率","value":rs.data.interest_rate_4};
		        	obj["interest_rate_5"] = {"text":"5年贷款利率","value":rs.data.interest_rate_5};
		        	obj["interest_rate_6"] = {"text":"6年贷款利率","value":rs.data.interest_rate_6};
		        	obj["interest_rate_7"] = {"text":"7年贷款利率","value":rs.data.interest_rate_7};
		        	obj["interest_rate_8"] = {"text":"8年贷款利率","value":rs.data.interest_rate_8};
		        	obj["interest_rate_9"] = {"text":"9年贷款利率","value":rs.data.interest_rate_9};
		        	obj["interest_rate_10"] = {"text":"10年贷款利率","value":rs.data.interest_rate_10};
		        	obj["acreage_coefficient"] = {"text":"面积系数","value":rs.data.acreage_coefficient};
		        	_json = obj;
		        	console.log(JSON.stringify(obj));
		        	jQuery("#state_subsidies_time").val(rs.data.state_subsidies_time);
		        	jQuery("#fund_subsidy_time").val(rs.data.fund_subsidy_time);
		        	
		        	jQuery("#gjbt").html(rs.data.state_subsidies);
		        	jQuery("#zybl").html(rs.data.use_rate);
		        	jQuery("#zyjg").html(rs.data.use_rate_price);
		        	jQuery("#swbl").html(rs.data.connect_rate);
		        	jQuery("#swjg").html(rs.data.connect_rate_price);
		        	
			        mui(document.body).on('tap','.mui-action-home',function(){
			            mui.back();
			        });
			
			        mui(document.body).on('click','.moshi',function(){
			            // mui.alert('11');
			            var value = jQuery(this).val();
			            if(value){
			                var key = value+'_price';
			                //默认价格
			                var danjia = _json[key]['value'];
			                jQuery('#price').val(danjia);
			                jQuery('#price').change();
			            }
			            jQuery('#touzi_type').val(value);
			        });
			
			        //贷款时间选择
			        var loanYearPicker = new mui.PopPicker();
			        var loanYearData = [];
			        for(var i=1;i<=10;i++){
			            loanYearData.push({
			                value: i,
			                text: '贷款'+i+'年'
			            });
			        }
			        loanYearPicker.setData(loanYearData);
			        var loan_year_btn = document.getElementById('loan_year_btn'); 
			        loan_year_btn.addEventListener('tap', function(event) {
			            loanYearPicker.show(function(items) {
			                var result = items[0];
			                jQuery('#loan_year').val(result.value);
			                var btnTz = jQuery('#loan_year_btn');
			                btnTz.text(result.text);
			
			                //选择贷款后改变利率
			                if(result.value > 0){
			                  var key = 'interest_rate_'+result.value;
			                  var rate = _json[key]['value'];
			                  jQuery('#year_rate').val(rate);
			                }
			            });
			        }, false);
			        //end
			
			        //改变单价的时候
			        jQuery('#price').change(function(){
			            setMoney();
			        });
			
			        //计算装机容量：单独的
			        jQuery('#ban_num').change(function(){
			            var userBan = parseInt(jQuery(this).val())||0;
			            var acreage_coefficient = parseFloat(_json.acreage_coefficient.value)||0;
			            var rongliang = userBan * acreage_coefficient;
			            rongliang = rongliang.toFixed(4);
			            jQuery('#rongliang').val(rongliang);
			            rongliangText = Math.floor(rongliang*100)/100;
			            jQuery('#rongliangText').val(rongliangText);
			            jQuery('#rongliang').change();
			        });
			        //装机容量调整后
			        jQuery('#rongliang').change(function(){
			            //计算年发电量
			            setDianYear();
			            setMoney();
			        });
			
			        jQuery('#touzi_year').change(function(){
			            var year = parseInt(jQuery('#touzi_year').val());
			            if(isNaN(year))jQuery('#touzi_year').val(25);
			            if(year > 50) mui.alert('确定能运营那么久？');
			        });
			
			        jQuery('#ok-view').click(function(){
			            var waiting = plus.nativeUI.showWaiting();
			            var that = this;
			            var key = ['touzi_type','rongliang','touzi_year','loan_year','touziShebei'];
			            var data = {};
			            data["sid"] = sid;
			            for(var kk in key){
			                data[key[kk]] = jQuery('#'+key[kk]).val();
			            }
			            var sign = GetSign(data);
			            data["method"] = config.apimethod.pertzdetail;
			            data["sign"] = sign;
			            var param = {
					        queryData:data,
					        method: 'POST'
					    }
			            $.dataRequest(param, function(rs) {
			            	console.log(JSON.stringify(rs));
			            	waiting.close();
			            	if(rs.rsp=="succ")
					        {
					        	if(rs.data.status=="succ"){
					        		jQuery('#touzi_rate').val(rs.data.shouyilv);
			                    	jQuery('#huibenyear').val(rs.data.huibenYear);
			                    	var allHtml = [];
				                    for(var kl in rs.data.view){
				                        if(kl == 0 || rs.data.view[kl].num == '合计'){
				                            if(kl == 0){
				                                rs.data.view[kl].num = "第"+rs.data.view[kl].num+"年";
				                            }
				                            var _html = substitute(jQuery('#mui_card_first').html(),rs.data.view[kl]);
				                            allHtml.push(_html);
				                        }else{
				                            rs.data.view[kl].num = "第"+rs.data.view[kl].num+"年";
				                            var _html = substitute(jQuery('#mui_card_after').html(),rs.data.view[kl]);
				                            allHtml.push(_html);
				                        }
				                    }
				                    jQuery('.mui-card-container').html(allHtml.join(''));
					        	}else
					        	{
					        		plus.nativeUI.toast("获取收益明细失败：" + rs.data.msg);
									return;
					        	}
					        }else
					        {
					        	plus.nativeUI.toast("获取收益明细失败：" + rs.res);
								return;
					        }
			            });
			        });
			        
				    //m默认选择全款投资模式
				    setTimeout(function(){
				        jQuery('.moshi:first').trigger('click');
				    },100);
				
					function setMoney(){
					    //计算设备投资
					    var Rongliang = parseFloat(jQuery('#rongliang').val())||0;
					    var price = parseFloat(jQuery('#price').val())||0;
					    var Money = toDecimal(Rongliang*price*1000);
					    jQuery('#touziShebei').val(Money);
					}
					//计算第一年年发电量
					function setDianYear(){
					    var rongliang = parseFloat(jQuery('#rongliang').val())||0;
					    var year_time = parseFloat(_json.year_time.value)||0;
					    var yearDian  = toDecimal(rongliang * year_time);
					    jQuery('#yearDian').val(yearDian);
					}
					
					//保留两位小数
					//功能：将浮点数四舍五入，取小数点后2位
					function toDecimal(x) {
					    var f = parseFloat(x);
					    if (isNaN(f)) {
					        return x;
					    }
					    f = Math.round(x*100)/100;
					    return f;
					}
					
					function substitute(str,o,regexp){
					
					  return  str.replace(regexp || /\\?\{([^{}]+)\}/g, function (match, name) {
					
					    return (o[name] === undefined) ? '' : o[name];
					
					  });
					
					}
		        }else
		        {
		        	plus.nativeUI.toast("获取失败：" + rs.data);
					return;
		        }
		    });
    	}
    });

</script>
</html>